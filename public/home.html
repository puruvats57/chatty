<!DOCTYPE html>
<html>

<head>
  <title>Chat App - Home</title>
</head>

<body>
  <h1>Home Page</h1>
  <a href="/creategrp">createGroup</a>
  <button onClick="logout()">Logout</button>

  <h2>JSON Data Display</h2>
  <div id="data-container"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    var userId;

    socket.on('messageCount', ({ id, text, msgid, senderuid, senderName, count }) => {
      console.log("Received messageCount event - id:", id, "count:", count);

      var additionalSpan = document.getElementById(id);
      if (additionalSpan) {
        console.log("Additional span element found:", additionalSpan);
        additionalSpan.textContent = `Message Count: ${count}`;
      } else {
        console.log("Additional span element not found for ID:", id);
      }
      var currentWindowUrl = window.location.href;
      console.log('Current URL:', currentWindowUrl);
      socket.emit('url', { url: currentWindowUrl, uid: userId, grpId: id, count });
    });
    var token;
    document.addEventListener("DOMContentLoaded", async function () {
      socket.emit('onHome');

      token = localStorage.getItem('token');

      if (token) {
        // Decode the token payload
        const payloadBase64 = token.split('.')[1];
        const payloadJson = atob(payloadBase64);
        const payload = JSON.parse(payloadJson);

        // Use the payload data
        console.log('Decoded Token Payload:', payload.id);

        const uid = payload.id; // Extracted UID from the payload
        userId = uid;

        const headers = new Headers({
          'Content-Type': 'application/json',
          // You can add any other headers you need, such as authentication headers
        });

        const bodyData = JSON.stringify({ uid }); // Create the request body

        // Fetch and display JSON data using a POST request
        var dataContainer = document.getElementById('data-container');

        try {
          const response = await fetch('http://localhost:5000/getGroups', {
            method: 'POST',
            headers,
            body: bodyData
          });

          if (response.ok) {
            const jsonData = await response.json();
            console.log("jsondata", jsonData);
            jsonData.formattedData.forEach(item => {
              console.log("items", item._id);
              const dataElement = document.createElement('p');
              // Create a link element for the group name
              const groupLink = document.createElement('a');
              groupLink.textContent = `${item.groupname}`;
              //groupLink.href = `/group?id=${item._id}`;
              groupLink.href = `/group/${item._id}`;
              const additionalSpan = document.createElement('span');
              additionalSpan.id = item._id;
              additionalSpan.textContent = `${item.count}`;
              dataElement.appendChild(groupLink);
              dataElement.appendChild(additionalSpan);
              dataContainer.appendChild(dataElement);
            });
          } else {
            console.error('Error fetching JSON data:', response.statusText);
          }
        } catch (error) {
          console.error('Error fetching JSON data:', error);
        }
      } else {
        console.error('Token not found');
      }
    });
    function logout() {
      console.log("token", token);
      localStorage.removeItem('token');
      window.location.href = '/'
    }
  </script>
</body>

</html>